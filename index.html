<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi Meter – Kompletná verzia</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }

    /* Mapa vľavo */
    #map {
        flex: 2;
        height: 100%;
        width: 100%;
    }

    /* Pravý panel */
    #rightPanel {
        flex: 1;
        background: #f4f4f4;
        padding: 15px;
        overflow-y: auto;
        border-left: 2px solid #ccc;
    }

    h2 {
        margin-top: 0;
    }

    input {
        width: 100%;
        padding: 8px;
        margin: 6px 0;
        font-size: 16px;
    }

    button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        font-size: 16px;
        cursor: pointer;
        background: #0078ff;
        color: white;
        border: none;
        border-radius: 4px;
    }

    #resetBtn {
        background: #444;
        margin-top: 5px;
    }

    /* Výsledky */
    #result {
        margin-top: 15px;
        padding: 10px;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    /* Warning box */
    #warningBox {
        display: none;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        font-weight: bold;
    }

    /* Debug panel */
    #debugPanel {
        margin-top: 15px;
        padding: 10px;
        background: #222;
        color: #0f0;
        height: 200px;
        overflow-y: auto;
        font-size: 12px;
        border-radius: 4px;
    }

    /* Autocomplete boxy */
    .sugBox {
        background: white;
        border: 1px solid #ccc;
        max-height: 120px;
        overflow-y: auto;
        margin-top: -5px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .sugItem {
        padding: 6px;
        cursor: pointer;
    }

    .sugItem:hover {
        background: #eee;
    }
</style>
</head>

<body>

<div id="map"></div>

<div id="rightPanel">
    <h2>TAXAMETER PL</h2>

    <label>Štart:</label>
    <input id="startInput" placeholder="Zadajte adresu">
    <div id="startSug" class="sugBox"></div>

    <label>Zastávka (voliteľné):</label>
    <input id="stopInput" placeholder="Zadajte adresu">
    <div id="stopSug" class="sugBox"></div>

    <label>Cieľ:</label>
    <input id="endInput" placeholder="Zadajte adresu">
    <div id="endSug" class="sugBox"></div>

    <label>Cenník:</label>
    <input id="cennikInput" Zadajte cenu podľa cenníka ">
	
    <button id="calcBtn">Vypočítať trasu</button>
    <button id="resetBtn">Nová trasa</button>

    <div id="warningBox"></div>
    <div id="result"></div>

    <h3>Debug panel</h3>
    <div id="debugPanel"></div>
	<div style="margin-top:20px; font-size:12px; color:#666; text-align:center;">
    Autor aplikácie: <b>Peter Lukáč (c) 2025 Všetky práva vyhradené</b>
</div>

</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =====================
// DEBUG PANEL
// =====================
function debug(msg) {
    const box = document.getElementById("debugPanel");
    const time = new Date().toLocaleTimeString();
    box.innerHTML += "[" + time + "] " + msg + "<br>";
    box.scrollTop = box.scrollHeight;
}

// =====================
// GLOBÁLNE PREMENNÉ
// =====================
let map;
let driverPosition = null;

let routeLineMain = null;
let routeLineApproach = null;

let startMarker = null;
let stopMarker = null;
let endMarker = null;

// =====================
// INICIALIZÁCIA MAPY
// =====================
window.addEventListener("load", () => {
    map = L.map("map").setView([48.7363, 19.1462], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    setTimeout(() => {
        map.invalidateSize();
        debug("Mapa inicializovaná.");
    }, 300);
});

// =====================
// GPS – POLOHA VODIČA
// =====================
if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(
        pos => {
            driverPosition = [pos.coords.latitude, pos.coords.longitude];
            debug("GPS aktualizácia: " + driverPosition.join(", "));
        },
        err => {
            debug("GPS chyba: " + err.message);
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 8000 }
    );
} else {
    debug("GPS nie je podporované.");
}

// =====================
// AUTOCOMPLETE – Nominatim
// =====================
async function autocomplete(query) {
    if (!query || query.length < 3) return [];

    const url =
        "https://nominatim.openstreetmap.org/search?format=json&q=" +
        encodeURIComponent(query);

    try {
        const r = await fetch(url);
        return await r.json();
    } catch (e) {
        debug("Autocomplete chyba: " + e);
        return [];
    }
}

function attachAutocomplete(inputId, sugId) {
    const input = document.getElementById(inputId);
    const sug = document.getElementById(sugId);

    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const list = await autocomplete(q);

        sug.innerHTML = "";

        list.forEach(item => {
            const div = document.createElement("div");
            div.className = "sugItem";
            div.textContent = item.display_name;
            div.onclick = () => {
                input.value = item.display_name;
                sug.innerHTML = "";
            };
            sug.appendChild(div);
        });
    });
}

attachAutocomplete("startInput", "startSug");
attachAutocomplete("stopInput", "stopSug");
attachAutocomplete("endInput", "endSug");

// =====================
// GEOCODING
// =====================
async function geocode(addr) {
    const url =
        "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" +
        encodeURIComponent(addr);

    try {
        const r = await fetch(url);
        const j = await r.json();
        if (j.length === 0) return null;

        return {
            lat: parseFloat(j[0].lat),
            lon: parseFloat(j[0].lon)
        };
    } catch (e) {
        debug("Geocode chyba: " + e);
        return null;
    }
}

// =====================
// FETCH ROUTE – OSRM
// =====================
async function fetchRoute(points) {
    const coords = points.map(p => `${p.lon},${p.lat}`).join(";");

    const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        coords +
        "?overview=full&geometries=geojson";

    try {
        const r = await fetch(url);
        const j = await r.json();

        if (!j.routes || j.routes.length === 0) return null;

        return {
            km: j.routes[0].distance / 1000,
            geometry: j.routes[0].geometry
        };
    } catch (e) {
        debug("Route chyba: " + e);
        return null;
    }
}
</script>
<script>
// =====================
// CENNÍK
// =====================
const COST_PER_KM = 0.31;

function calcCost(km) {
    return km * COST_PER_KM;
}

// =====================
// VAROVACÍ BOX
// =====================
function showWarning(msg) {
    const box = document.getElementById("warningBox");
    box.style.display = "block";
    box.style.background = "#8b0000";
    box.style.color = "#fff";
    box.textContent = msg;
}

function hideWarning() {
    const box = document.getElementById("warningBox");
    box.style.display = "none";
    box.textContent = "";
}

// =====================
// RESET UI – NOVÁ TRASA
// =====================
function resetUI() {
    document.getElementById("startInput").value = "";
    document.getElementById("stopInput").value = "";
    document.getElementById("endInput").value = "";
    document.getElementById("cennikInput").value = "";

    document.getElementById("startSug").innerHTML = "";
    document.getElementById("stopSug").innerHTML = "";
    document.getElementById("endSug").innerHTML = "";

    document.getElementById("result").innerHTML = "";
    hideWarning();

    if (routeLineMain) { map.removeLayer(routeLineMain); routeLineMain = null; }
    if (routeLineApproach) { map.removeLayer(routeLineApproach); routeLineApproach = null; }

    if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
    if (stopMarker) { map.removeLayer(stopMarker); stopMarker = null; }
    if (endMarker) { map.removeLayer(endMarker); endMarker = null; }

    debug("UI resetované – pripravené na novú trasu.");
}

document.getElementById("resetBtn").onclick = resetUI;

// =====================
// HLAVNÝ VÝPOČET TRASY + DOJAZDU
// =====================
document.getElementById("calcBtn").onclick = async () => {
    const start = document.getElementById("startInput").value.trim();
    const end = document.getElementById("endInput").value.trim();
    const stop = document.getElementById("stopInput").value.trim();
    const cennik = parseFloat(document.getElementById("cennikInput").value);

    if (!start || !end) {
        alert("Zadajte štart aj cieľ.");
        return;
    }

    debug("=== VÝPOČET TRASY + DOJAZDU ===");
    debug("Štart: " + start);
    debug("Cieľ: " + end);
    if (stop) debug("Zastávka: " + stop);

    // 1) Geokódy adries
    debug("Geokódujem adresy...");
    const pStart = await geocode(start);
    const pEnd = await geocode(end);
    const pStop = stop ? await geocode(stop) : null;

    if (!pStart || !pEnd) {
        alert("Nepodarilo sa nájsť adresu štartu alebo cieľa.");
        return;
    }

    // 2) Príprava bodov hlavnej trasy (štart -> zastávka? -> cieľ)
    let mainPoints = [pStart];
    if (pStop) mainPoints.push(pStop);
    mainPoints.push(pEnd);

    // 3) Výpočet DOJAZDU (vodič -> štart), ak máme GPS pozíciu
    let approachKm = 0;
    let approachInfoText = "";

    if (driverPosition) {
        debug("Mám GPS pozíciu vodiča, rátam dojazd...");
        const routeApproach = await fetchRoute([
            { lat: driverPosition[0], lon: driverPosition[1] },
            pStart
        ]);

        if (routeApproach) {
            approachKm = routeApproach.km;
            approachInfoText = `Dojazd vodiča: ${approachKm.toFixed(2)} km`;

            if (routeLineApproach) map.removeLayer(routeLineApproach);
            routeLineApproach = L.geoJSON(routeApproach.geometry, {
                style: { color: "yellow", weight: 5 }
            }).addTo(map);
        }
    } else {
        debug("GPS pozícia vodiča nie je dostupná.");
    }

    // 4) Výpočet hlavnej trasy
    debug("Rátam hlavnú trasu...");
    const routeMain = await fetchRoute(mainPoints);

    if (!routeMain) {
        alert("Nepodarilo sa vypočítať trasu.");
        return;
    }

    const mainKm = routeMain.km;

    if (routeLineMain) map.removeLayer(routeLineMain);
    routeLineMain = L.geoJSON(routeMain.geometry, {
        style: { color: "green", weight: 5 }
    }).addTo(map);

    // 5) Markery
    if (startMarker) map.removeLayer(startMarker);
    if (stopMarker) map.removeLayer(stopMarker);
    if (endMarker) map.removeLayer(endMarker);

    startMarker = L.marker([pStart.lat, pStart.lon]).addTo(map);
    if (pStop) stopMarker = L.marker([pStop.lat, pStop.lon]).addTo(map);
    endMarker = L.marker([pEnd.lat, pEnd.lon]).addTo(map);

    // 6) Výpočet ceny podľa tvojho vzorca (EKONOMICKÁ REALITA)
const costApproach = approachKm * 0.40;   // vodič -> štart
const costMain = mainKm * 0.85;           // jazda so zákazníkom
const realCost = costApproach + costMain;

// 6b) Cena podľa vodiča (KONEČNÁ SUMA, NIE €/km)
const driverCost = cennik;  // vodič zadá hotovú cenu jazdy

// 6c) Porovnanie
let lossWarning = "";
if (driverCost < realCost) {
    lossWarning = "Pozor: Táto jazda je stratová podľa ekonomického výpočtu!";
    showWarning(lossWarning);
} else {
    hideWarning();
}

// Debug výpisy
debug("Hlavná trasa: " + mainKm.toFixed(2) + " km");
debug("Dojazd: " + approachKm.toFixed(2) + " km");
debug("Reálna cena (vzorec): " + realCost.toFixed(2) + " €");
debug("Cena podľa cenníka (konečná): " + driverCost.toFixed(2) + " €");
debug("Rozdiel: " + (driverCost - realCost).toFixed(2) + " €");

// 7) Výstup
let html = `
    <b>Hlavná trasa:</b> ${mainKm.toFixed(2)} km<br>
    <b>Dojazd vodiča:</b> ${approachKm.toFixed(2)} km<br><br>

    <b>Reálna cena podľa vzorca:</b> ${realCost.toFixed(2)} €<br>
    <b>Cena podľa cenníka (konečná):</b> ${driverCost.toFixed(2)} €<br><br>

    <b><u>Rozdiel:</u></b> ${(driverCost - realCost).toFixed(2)} €<br>
`;

document.getElementById("result").innerHTML = html;



    // 8) Varovanie pri nerentabilite
    if (approachKm > mainKm) {
        showWarning("Pozor: Dojazd je dlhší ako samotná jazda!");
    } else {
        hideWarning();
    }
};
</script>
</body>
</html>
