<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Najbližšie nemocnice</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    #map { height: 80vh; }
    #info { padding: 10px; }
    .hospital { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2 style="padding:10px;">Vyhľadanie najbližších nemocníc</h2>
  <div id="map"></div>
  <div id="info"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map, userMarker;

    async function init() {
      if (!navigator.geolocation) {
        alert("Geolokácia nie je podporovaná.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // Inicializácia mapy
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap'
        }).addTo(map);

        userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Moja poloha").openPopup();

        // Overpass dotaz
        const query = `
          [out:json];
          (
            node["amenity"="hospital"](around:5000,${lat},${lon});
            way["amenity"="hospital"](around:5000,${lat},${lon});
            relation["amenity"="hospital"](around:5000,${lat},${lon});
          );
          out center;
        `;
        const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
        const response = await fetch(url);
        const data = await response.json();

        const infoDiv = document.getElementById("info");
        infoDiv.innerHTML = "<h3>Nájdené nemocnice:</h3>";

        data.elements.forEach(el => {
          const name = el.tags?.name || "Neznáma nemocnica";
          const phone = el.tags?.phone || "Tel. nedostupné";
          const addr = el.tags?.["addr:street"] || "";
          const city = el.tags?.["addr:city"] || "";
          const coords = el.lat ? [el.lat, el.lon] : [el.center.lat, el.center.lon];

          // Marker na mape
          const marker = L.marker(coords).addTo(map);
          marker.bindPopup(`<b>${name}</b><br>${addr} ${city}<br>${phone}`);

          // Info panel
          const div = document.createElement("div");
          div.className = "hospital";
          div.innerHTML = `
            <strong>${name}</strong><br>
            ${addr} ${city}<br>
            Tel: ${phone}<br>
            <button onclick="routeTo(${coords[0]},${coords[1]})">Ukázať trasu</button>
          `;
          infoDiv.appendChild(div);
        });
      });
    }

    async function routeTo(lat, lon) {
      if (!userMarker) return;
      const userPos = userMarker.getLatLng();
      const url = `https://router.project-osrm.org/route/v1/driving/${userPos.lng},${userPos.lat};${lon},${lat}?overview=full&geometries=geojson`;

      const response = await fetch(url);
      const data = await response.json();
      const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

      L.polyline(coords, {color: 'blue'}).addTo(map);
      map.fitBounds(L.polyline(coords).getBounds());
    }

    init();
  </script>
</body>
</html>
